<!--
PAGE_ Method Documentation:
=========================

PAGE_ProcessResponse(oData) - Handles server response data and displays it in the response container based on data type
PAGE_SetListeners() - Configures event listeners for page interactions, handling actions like send and save
PAGE_Update(source_) - Updates page elements with data from a source object, typically a CDocument instance
PAGE_OnIdle - Handles idle state by updating UI elements and checking for changes
PAGE_Initialize() - Main initialization function that sets up the page, creates draggable elements and configures listeners
PAGE_Callback(sName, ...args) - Retrieves and executes a callback by name with any provided arguments

-->

<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <link rel="stylesheet" href="variables-default.css">
   <link rel="stylesheet" href="css/elements.css">
   <script src="js/classes/gd_data_table.js"></script>
   <script src="js/classes/gd_ui_draggable.js"></script>
   <title>Test session logic in http web server</title>
   <style>
   html { height: 100%; margin: 0; overflow: hidden; padding: 0; }
   body { background-color: var(--bs-body-bg); box-sizing: border-box; color: var(--bs-body-color); font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif; line-height: 1.5; margin: 0; min-height: 100%; overflow: hidden; padding: 0px; }

   /* ## page classes to style the complete page */
   .page-800 { display: block; margin: 0 auto; width: 800px; }
   .page-1000 { display: block; height: 100%; margin: 0 auto; width: 1000px; }

   .button-normal { background-color: var(--background-primary); border-radius: 4px; color: var(--color-primary); cursor: pointer; min-width: 100px; padding: 8px 16px; text-align: center; }
   .caption { background-color: var(--background-secondary); border-radius: 4px; font-weight: bold; margin-bottom: 10px; padding: 8px 16px;      }

   #idPage { display: grid; grid-template-rows: auto 1fr;  height: 100vh; margin: 0 auto; overflow: hidden; width: 1400px; }

   /* Add your CSS styles here */
   .container-form { container-type: inline-size; }

   .container-form input,
   .container-form textarea,
   .container-form select {border: 1px solid #ddd; border-radius: 6px; font-family: inherit; font-size: inherit; padding: 8px 12px;}

   .container-form .row { align-items: center; display: flex; gap: 12px; margin-bottom: 16px; }
   .container-form .row:last-child { margin-bottom: 0; } /* to align last item to bottom */

   .container-form .fill {flex: 1;} /* makes select fill available width */
   .container-form .half { flex: 1; max-width: 50%; }
   .container-form .third { flex: 1; max-width: 33.33%; }
   .container-form .quarter { flex: 1; max-width: 25%; }

   .container-form .padding-5 { padding: 5px; }

   .container-form .right { justify-content: flex-end; }

   /* page classes */

   .page-plate { background-color: var(--background-body); }
   .page-command { cursor: pointer;  }
   .page-row { background-color: var(--background-body); display: flex; border-radius: 4px; border: 1px solid #ddd; width: 100%; }

   .page-row-content { cursor: pointer; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
   .page-delete-button { background-color: var(--background-danger); border: none; border-radius: 50%; color: var(--color-danger); cursor: pointer; height: 20px; width: 20px; line-height: 18px; flex-shrink: 0; opacity: 0; transition: opacity 0.2s, background-color 0.2s;  z-index: 10; text-align: center; font-size: 16px; }
   .page-row:hover .page-delete-button { opacity: 1;  }
   .page-delete-button:hover { background-color: var(--background-danger); opacity: 1;  transform: scale(1.1); }

   .page-button-focus { background-color: var(--background-active); color: var(--color-primary); }

   </style>
</head>
<body>
   <div id="idPage">
      <div>
         <div id="idMenu" class="container container-form">
            <div class="row padding-5">
               <span class="button-normal" data-action="load-page">Load page</span>
               <span class="button-normal" data-action="save-page">Save page</span>
            </div>
         </div>
         <h1>HTTP Session Test Page</h1>
         <div id="idServer" class="container container-form">
            <div class="row">
               <input class="fill" data-field="address" placeholder="Address to server" />
               <input class="quarter" data-field="port" placeholder="port number" />
            </div>
         </div>
         <div id="idUrl" class="container container-form">
            <div class="row">
               <input class="fill" data-field="url" placeholder="Url" />
            </div>
         </div>
      </div>

      <div id="idWorkArea" style="border: 1px solid black; position: relative;">

         <!-- Section used to display endpoint information and commands to save and send -->
         <div id="idCommands" class="container container-form page-plate" data-name="command" data-draggable="1" style="border: 1px solid black; border-radius: 6px; position: absolute; top: 20px; left: 20px; padding: 5px; width: 800px;">
            <div class="caption row handle" data-draggable-handle="1">Command: Endpoint information</div>
            <form data-element="container">
               <div class="row">
                  <input type="text" class="fill" data-field="alias" placeholder="Alias name for command" />
               </div>
               <div class="row">
                  <textarea class="fill" rows="3" data-field="endpoint" placeholder="Endpoint URL"></textarea>
               </div>
               <div class="row">
                  <textarea class="fill" rows="2" data-field="description" placeholder="Endpoint description"></textarea>
               </div>
               <div class="row right">
                  <span class="button-normal" data-action="send">Send</span>
                  <span class="button-normal" data-action="save">Keep</span>
               </div>
            </form>
         </div>

         <!-- Section used to display server response -->
         <div id="idResult" class="container container-form page-plate" data-name="result" data-draggable="1" style="border: 1px solid black; border-radius: 6px; position: absolute; top: 500px; left: 100px; padding: 5px; width: 800px;">
            <div class="caption row handle" data-draggable-handle="1">Command: Server response</div>
            <form data-element="container">
               <div class="row">
                  <textarea class="fill" rows="3" data-field="response" placeholder="Server response"></textarea>
               </div>
            </form>
         </div>

         <!-- Section used to display history of saved command/endpoints -->
         <div id="idHistory" class="container container-form page-plate" data-name="history" data-draggable="1" style="border: 1px solid black; border-radius: 6px; position: absolute; top: 800px; left: 100px; padding: 5px; height: 300px; width: 800px;">
            <div class="caption row handle" data-draggable-handle="1">Command: History</div>
            <div class="row" data-section="commands" style="flex-direction: column; align-items: stretch; gap: 8px;">

            </div>
         </div>

      </div>
   </div>

   <script>
      // Make oDocument a global variable
      let oDocument_g;

      class CDocument {
         static iIdleTimerId_s = null; // Global timer ID for idle callback

         constructor( oOptions = {} ) {
            this.bModified = false; // Initialize modified flag to false
            this.aObject = [];
            this.aCache = [];
            this.aTableCache = []; // Hold table data like [{id: <string>, table: <table object>}, ...]
            this.aCallback = oOptions.callbacks || [];
            this.fnCallback = oOptions.callback || null;
         }

         // Check if document has been modified ------------------------------
         IsModified() { return this.bModified; }
         // Set modified flag to true or false -------------------------------
         SetModified(bModified) { this.bModified = bModified; }

         /// Add object to document ------------------------------------------
         Add(sType, oObject) {
            const sId = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
            this.aObject.push({ id: sId, type: sType, object: oObject });
            this.bModified = true;
         }

         /// Add object to cache ---------------------------------------------
         AddCacheItem(sKey, oObject) {
            this.aCache[sKey] = oObject;
            this.bModified = true;
         }

         AddTableCacheItem(sId, oTable) {
            this.aTableCache.push({ id: sId, table: oTable });
            this.bModified = true;
         }

         /// Get first object by type ----------------------------------------
         Get(type_) {
            if( typeof type_ === "string") {
               return this.aObject.find(o => o.type === type_);
            }
            return this.aObject.find(o => o.id === type_.id);                 // if not string then type_ is { id: <id> }
         }

         /// Return object item from entry -----------------------------------
         GetObject(sType) {
            const oEntry = this.Get(sType);
            return oEntry.object;
         }

         /// Returns all objects for type in array ---------------------------
         GetAll(sType) {
            return this.aObject.filter(o => o.type === sType);
         }

         /// Return cache item from entry -----------------------------------
         GetCacheItem(sKey) {
            return this.aCache[sKey];
         }

         /// Return table cache item from entry -----------------------------
         GetTableCacheItem(sId) {
            let o_ = this.aTableCache.find(o => o.id === sId);
            if(o_) { return o_.table; }
            return null;
         }

         DeleteTableCache(sCacheName, iIndex) {
            const oTable = this.GetTableCacheItem( sCacheName );
            if(oTable) { oTable.Delete(iIndex); this.bModified = true; }
         }

         /// Remove object from array ----------------------------------------
         Remove(sId) {
            const iIndex = this.aObject.findIndex(o => o.id === sId);
            if(iIndex !== -1) {
               this.aObject.splice(iIndex, 1);
            }
         }

         /// Save the entire aObject array to localStorage -------------------
         Save() {
            try {
               // ## Save object data ..........................................
               const sObjectData = JSON.stringify(this.aObject);
               localStorage.setItem('document', sObjectData);

               let oTableCache = {};

               // ## Save table cache .........................................
               for(let o of this.aTableCache) {
                  oTableCache[o.id] = o.table.Data();                         // Save table data as an array
               }
               localStorage.setItem('table-cache', JSON.stringify(oTableCache));

               this.bModified = false;                                        // Reset modified flag after saving
            } catch(e) { console.error('Failed to save to localStorage:', e); }
         }

         /// Load the aObject array from localStorage (if exists) ------------
         Load() {
            try {
               const sObjectData = localStorage.getItem('document');
               if(sObjectData) {
                  const aObject = JSON.parse(sObjectData);
                  if(Array.isArray(aObject)) {
                     this.aObject = aObject;
                  }
               }

               // ## Load table cache .........................................
               const sTableCache = localStorage.getItem('table-cache');
               if(sTableCache) {
                  const oTableCache = JSON.parse(sTableCache);
                  for(let sId in oTableCache) {
                     let oTable = this.GetTableCacheItem( sId );
                     const aRow = oTableCache[sId];
                     if(oTable) oTable.Add(aRow);
                  }
               }
               return true;                                                   // success
            } catch(e) {
               console.error('Failed to load from localStorage:', e);
               this.aObject = [];
            }
            return false;                                                     // no data or failed
         }

         /// Register a callback with a name ----------------------------------
         AddCallback(sName, fnCallback) {                                                          console.assert( typeof fnCallback === 'function' );
            this.aCallback.push({ name: sName, callback: fnCallback });
            return true;
         }

         /// Get a callback by name -------------------------------------------
         GetCallback(sName) {
            const oCallback = this.aCallbacks.find(o => o.name === sName);
            return oCallback ? oCallback.callback : null;
         }

         /// Call a callback by name with any arguments ------------------------
         CallCallback(sName, ...args) {
            const fnCallback = this.GetCallback(sName);
            if(fnCallback) {
               try {
                  fnCallback(...args);
                  return true;
               } catch(e) {
                  console.error('Error executing callback "' + sName + '":', e);
                  return false;
               }
            }
            else if(this.fnCallback) {
               try {
                  this.fnCallback(sName, ...args);
                  return true;
               } catch(e) {
                  console.error('Error executing default callback:', e);
                  return false;
               }
            }
            return false;
         }
      }

      /** ---------------------------------------------------------------------
       * Send arguments to server,
       * @param {string} sEndpointÂ´- endpoint with arguments added after generated domain name
       * @param {string} [sBody] - optional body sent to server
       */
      function SERVER_Send(sEndpoint, sBody) {
         // ## Prepare variables  .............................................

         const eServerContainer = document.getElementById('idServer');         // Get the server information container

         const eAddress = eServerContainer.querySelector('[data-field="address"]'); // address (domain)
         const ePort = eServerContainer.querySelector('[data-field="port"]'); // port

         if(!eAddress) { console.error('Server address field not found'); return; }

         const sAddress = eAddress.value.trim();
         const sPort = ePort.value.trim();

         if(!sAddress) { console.error('Server address is required'); return; } // Validate that we have the required values

         // ## Build the base URL .............................................

         let sBaseUrl = sAddress;

         if(sPort) {                                                           // Add port if provided (and not already included in address)
            // Check if address already has a port (contains : followed by numbers)
            const bHasPort = /:\d+/.test(sAddress);
            if(bHasPort === false) {
               // ### Remove trailing slash if present before adding port
               sBaseUrl = sBaseUrl.replace(/\/$/, '');
               sBaseUrl += ':' + sPort;
            }
         }

         if(!sBaseUrl.endsWith('/')) { sBaseUrl += '/'; }                     // Ensure base URL ends with slash for proper endpoint concatenation
         const sCleanEndpoint = sEndpoint.startsWith('/') ? sEndpoint.substring(1) : sEndpoint; // Remove leading slash from endpoint if present (to avoid double slashes)
         const sFullUrl = sBaseUrl + sCleanEndpoint;                          // Build the complete URL

         // ## Set url to top element showing active url
         document.getElementById('idUrl').querySelector("[data-field='url']").value = sFullUrl;

         console.log('Sending request to:', sFullUrl);

         // ## Prepare fetch options ..........................................

         const oOptions = {
            method: 'GET', // Default method
            headers: { 'Content-Type': 'application/xml' }
         };

         // If body is provided, use POST method and add body
         if(sBody !== undefined) {
            oOptions.method = 'POST';
            oOptions.body = JSON.stringify(sBody);
         }

         // ## Send the request and pick up the response as { type: <format>, data: <data> }

         return fetch(sFullUrl, oOptions)
         .then(response => {
            // ### Handle response data .......................................

            if(!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }

            // Check the content type to determine how to parse the response
            const sContentType = response.headers.get('content-type');

            if(sContentType && sContentType.includes('application/json')) {
                return response.json().then(data => ({ type: 'json', data }));
            }
            else if(sContentType && (sContentType.includes('application/xml') || sContentType.includes('text/xml'))) {
               return response.text().then(text => {
                  const oDOMParser = new DOMParser();
                  const xml_ = oDOMParser.parseFromString(text, "text/xml");
                  return { type: 'xml', data: xml_ };
               });
            }
            else {
               return response.text().then(data => ({ type: 'text', data }));
            }
         })
         .then(data => {
            // ### Handle parsed data .........................................

            //console.log('Response received:', data);

            // If needed, you can add XML parsing here
            // const parser = new DOMParser();
            // const xmlDoc = parser.parseFromString(data, "text/xml");

            return data;                                                       // Return the parsed data
         })
         .catch(error => {
            console.error('Error sending request:', error);
            // You could add error handling UI here
            throw error;
         });
      }

      /** ---------------------------------------------------------------------
       * Handle response data and display it in the container
       *
       * Response data format is { type: <format>, data: <data> } and type can be any of
       * json, xml or text. "type" is the format of the data, e.g. "json", "xml", "text"
       *
       * @param {object} oData - The response data to process, format is { type: <format>, data: <data> }
       */
      function PAGE_ProcessResponse(oData) {

         // ## Print data to element that shows current response ..............
         // Container = "idResult" and element = data-field="response"

         let sResult;

         // extract the data and convert it to text and place it in sResult
         switch(oData.type) {
            case 'json':
               sResult = JSON.stringify(oData.data, null, 2);
               break;
            case 'xml':
               // If oData.data is an XML Document object, serialize it to string
               if (oData.data instanceof XMLDocument || oData.data.nodeType === 9) {
                  sResult = (new XMLSerializer()).serializeToString(oData.data);
               } else {
                  // If it's already a string, use it directly
                  sResult = oData.data;
               }
               break;
            case 'text':
               sResult = oData.data;
               break;
            default:
               sResult = 'Unknown format';
         }

         document.getElementById('idResult').querySelector('[data-field="response"]').textContent = sResult;
      }

      function PAGE_UpdateCommands(container_, aCommands) {
         let eContainer = container_;
         if(typeof container_ === 'string') { eContainer = document.getElementById(container_); }
         if(Array.isArray(aCommands)) {
            for(let oCommand of aCommands) {
               //let eElement = eContainer.querySelector(`[data-command="${oCommand.id}"]`);
               //if(eElement) { eElement.value = oCommand.name; }
            }
         }
      }

      /** --------------------------------------------------------------------- @API [tag: update, page]
       * Update page from source data
       */
      function PAGE_Update(source_ = oDocument_g) {
         // ## check if source_ is instance of CDocument
         if((source_ instanceof CDocument) === true) {
            const oDocument = source_;

            // ## Update Url .................................................
            const eServer = document.getElementById("idServer");
            const oServer = oDocument.Get("server");
            if( oServer ) {
               const o = oServer.object;
               eServer.querySelector( '[data-field="address"]' ).value = o.address;
               eServer.querySelector( '[data-field="port"]' ).value = o.port;

               const eUrl = document.getElementById("idUrl");
               const sUrl = `${o.address}:${o.port}`;
               eUrl.querySelector( '[data-field="url"]' ).value = sUrl;
            }

            // ## Update history from endpoints ...............................

            const sCacheName = "endpoint";
            const oTable = oDocument.GetTableCacheItem( sCacheName );

            const eHistory = document.getElementById("idHistory"); // history element
            const eCommands = document.querySelector('[data-section="commands"]'); // commands element used as container
            eCommands.innerHTML = '';

            const iRowCount = oTable.Size();
            for( let iRow = 0; iRow < iRowCount; iRow++ ) {
               const eElement = document.createElement("div");
               const o = oTable.AsObject(iRow);
               let sName = o.alias;
               sName += " - ";
               sName += o.endpoint.length > 60 ? o.endpoint.substr(0, 57) + '...' : o.endpoint;
               eElement.textContent = sName;

               eElement.dataset.action = "activate-command";
               eElement.dataset.data = JSON.stringify( o );
               eElement.dataset.index = iRow;
               eElement.dataset.cache = sCacheName;
               eElement.classList.add("page-row-content");

               // Create delete button (X)
               const eDelete = document.createElement('button');
               eDelete.classList.add("page-delete-button");
               eDelete.textContent = "x";
               eDelete.dataset.action = "delete-command";
               eDelete.dataset.index = iRow;
               eDelete.dataset.cache = sCacheName;
               eDelete.title = "Delete this command";

               const eRow = document.createElement("div");
               eRow.classList.add("page-row");

               eRow.appendChild(eElement);
               eRow.appendChild(eDelete);

               eCommands.appendChild(eRow);
            }
         }
         // ## if source_ is element
         else if( source_ === "draggable" ) {
            const eContainer = document.getElementById('idWorkArea');
            if( eContainer.id === "idWorkArea" ) {
               // ### Place the containers to saved positions
               const aPosition = oDocument_g.GetAll("draggable");

            }
         }
      }


      /**
       * Handles idle state by updating UI elements and checking for changes
       */
      const PAGE_OnIdle = (function() {
         var bLastModified = false;

         return function() {
            const bModified = oDocument_g.IsModified();

            if( bModified !== bLastModified ) {
               let eSave = document.getElementById("idMenu").querySelector('[data-action="save-page"]');

               if( bModified === true ) {
                  eSave.classList.add("page-button-focus");
               }
               else {
                  eSave.classList.remove("page-button-focus");
               }
               bLastModified = bModified;
            }
         }
      })();


      /** --------------------------------------------------------------------- @API [tag: initialize]
       * Main initialization function that initializes the page
       */
      function PAGE_Initialize() {
         const eWorkArea = document.getElementById('idWorkArea');

         const oOptions = {
            oBounds: {
               eElement: eWorkArea,
               oPadding: { top: 20, right: 20, bottom: 20, left: 20 }
            }
         };

         // ## Initialize draggable elements
         const aDraggable = document.querySelectorAll('[data-draggable]');    // find all draggable elements
         aDraggable.forEach(function(eElement) {
            let eHandle = eElement.querySelector("[data-draggable-handle]");
            oOptions.eHandle = eHandle;
            const oDraggable = new UIDraggable(eElement, oOptions);
            const sName = eElement.getAttribute('data-name');
            const oPosition = oDraggable.GetPosition();
            oDocument_g.Add("draggable", { name: sName, position: oDraggable.GetPosition() });
            oDocument_g.AddCacheItem(["draggable-" + sName, oDraggable]);      // Add draggable object to cache
         });

         // ## Initialize table cache items
         let oTable = new Table(["alias", "endpoint","body", "description"]);  // table storing endpoints
         oDocument_g.AddTableCacheItem("endpoint", oTable);                   // Add table object to cache

         PAGE_SetListeners();
         oDocument_g.Load();
         oDocument_g.SetModified(false);

         // ## Start idle timer - call PAGE_OnIdle() once per second
         CDocument.iIdleTimerId_s = setInterval(PAGE_OnIdle, 1000);
      }

      /** --------------------------------------------------------------------- @API [tag: event, command]
       * Configure page listeners, handle page specific events
       */
      function PAGE_SetListeners() {

         // ## Initialize page menu listener ..................................

         const eMenu = document.getElementById('idMenu');
         eMenu.addEventListener('click', function(e_) {
            const eTarget = e_.target;
            if(!eTarget.dataset.action) return;                             // If no action is defined, return
            e_.stopPropagation();
            const sAction = eTarget.dataset.action;
            switch(sAction) {
               case 'load-page':
                  oDocument_g.Load();
                  PAGE_Update();
                  break;
               case 'save-page':
                  oDocument_g.Save();
                  break;
               default:
                  console.error('Unknown action:', sAction);
            }

         });

         // ## Initialize page work area listener .............................

         const eWorkArea = document.getElementById('idWorkArea');
         eWorkArea.addEventListener('click', function(e_) {
            const eTarget = e_.target;
            if(!eTarget.dataset.action) return;                             // If no action is defined, return
            e_.stopPropagation();
            const eContainer = eTarget.closest('.container');
            const sAction = eTarget.dataset.action;
            switch(sAction) {
               case 'send': {                                                 // send command to wed server
                  const sEndpoint = eContainer.querySelector('[data-field="endpoint"]').value;
                  SERVER_Send(sEndpoint).then( function(oResponse) {  PAGE_ProcessResponse( oResponse ); });
               } break;
               case 'save': {                                                  // save command
                  const eCommands = document.getElementById('idCommands');
                  const aFields = eCommands.querySelectorAll('[data-field]');
                  const oCommand = {};

                  aFields.forEach(eField => {
                     const sField = eField.dataset.field;
                     oCommand[sField] = eField.value;
                  });

                  let oTable = oDocument_g.GetTableCacheItem("endpoint");
                  oTable.Add(oCommand);

                  oDocument_g.Add("command", oCommand);
                  oDocument_g.Save();
               } break;
               case 'activate-command': {                                      // activate command
                  const sCacheName = eTarget.dataset.cache;
                  const oTable = oDocument_g.GetTableCacheItem(sCacheName);
                  const iIndex = eTarget.dataset.index;
                  const oCommand = oTable.AsObject( iIndex );
                  const eCommands = document.getElementById('idCommands');
                  if(eCommands) {
                     const aFields = eCommands.querySelectorAll('[data-field]');
                     aFields.forEach(eField => {
                        const sField = eField.dataset.field;
                        eField.value = oCommand[sField];
                     });
                  }
               } break;
               case 'delete-command': {                                        // delete command
                  const sCacheName = eTarget.dataset.cache;
                  const iIndex = eTarget.dataset.index;
                  oDocument_g.DeleteTableCache(sCacheName, iIndex);
                  PAGE_Update();
               } break;
               default:
                  console.error('Unknown action:', sAction);
            }
         });
      }

      function PAGE_Callback(sName, ...args) {
         const fnCallback = oDocument_g.GetCallback(sName);
         if(fnCallback) {
            try {
               fnCallback(...args);
               return true;
            } catch(e) {
               console.error('Error executing callback "' + sName + '":', e);
               return false;
            }
         }
         return false;
      }

      // Initialize draggable element
      document.addEventListener('DOMContentLoaded', function() {
         oDocument_g = new CDocument( {callback: PAGE_Callback} );
         oDocument_g.Add("server", { address: "http://localhost", port: "8001" })
         PAGE_Initialize();                                                    // Initialize page
         PAGE_Update(oDocument_g);
      });

   </script>
</body>
</html>
