<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/elements.css">
    <title>Document</title>
    <style>
    /* Add your CSS styles here */
    .container-form { container-type: inline-size; margin: 20px; }

    .container-form input,
    .container-form textarea,
    .container-form select {border: 1px solid #ddd; border-radius: 6px; font-family: inherit; font-size: inherit; padding: 8px 12px;}

    .container-form .row { align-items: center; display: flex; gap: 12px; margin-bottom: 16px; }
    .container-form .row:last-child { margin-bottom: 0; } /* to align last item to bottom */

    .container-form .fill {flex: 1;} /* makes select fill available width */
    .container-form .half { flex: 1; max-width: 50%; }

    .container-form .right { justify-content: flex-end; }

    </style>
</head>
<body>

    <div class="container container-form" style="max-width: 800px;">
        <div class="row">
            Name:
            <textarea class="fill" id="idName"></textarea>
        </div>
        <div class="row">
            Value:
            <textarea class="fill" id="idValue"></textarea>
        </div>
        <div class="row right">
            <select class="half" id="idSelect">

            </select>
        </div>
        <div class="row right">
         <button id="idAdd">Add</button>
         <button id="idSave">Save</button>
         <button id="idRemove">Remove</button>
         <button id="idClear">Clear</button>
        </div>
    </div>

    <hr>

    <label id="idSelectText"></label>
    
    <table id="idTable"></table>

</body>
<script>
    /*function SetText(eText, sKey)
    {
        const sValue = localStorage.getItem(sKey);

        eText.value = sValue;
    }

    function SaveText(eText, sKey)
    {
        let sValue = eText.value;

        localStorage.setItem(sKey, sValue);
    }

    function ChangeLabel(eParent)
    {
        if(!eParent) return;

        const eTextarea = eParent.querySelector("#idTextarea");
        SaveText(eTextarea, "text");
        alert("Clicked");
    }*/

    class Table
    {
        constructor(parent_)
        {
            let oParent;
            if( typeof parent_ === "string" )
            {
                oParent = document.querySelector(parent_);
                if(!oParent) document.getElementById(parent_);
            }
            else
            {
                oParent = parent_; 
            }
            this.eParent = oParent;
        }
    
        /** -------------------------------------------------------------------
         * Adds data to the table.
         *
         * Accepts input in multiple formats:
         * - String → split into cells using a separator and added as a single row
         * - 1D array → treated as a single row
         * - 2D array → treated as multiple rows
         *
         * @param {string | Array} table_
         *   - String: "a,b,c"
         *   - 1D array: ["a", "b", "c"]
         *   - 2D array: [["a", "b"], ["c", "d"]]
         * @param {string} [sSeperator=","] Character used to split string input
         */
        Add(table_, sSeperator) 
        {
            let aTable = table_;
            if(typeof table_ === "string")
            {
                if(!sSeperator) {sSeperator = ","}
                aTable = [table_.split(sSeperator)];
            }
            else if(Array.isArray(table_) && table_.every(Array.isArray) == false)
            {
                aTable = [table_];
            }   

            aTable.forEach(aRow => {
                const eRow = document.createElement("tr");
                this.eParent.appendChild(eRow);

                aRow.forEach(cell_ => {
                    let eCell = document.createElement("td");
                    eCell.textContent = cell_;
                    eRow.appendChild(eCell);
                });
            });
        }

        /**
         * Deletes one or more rows from the parent table.
         *
         * @param {number} iStart - Index of the first row to delete
         * @param {number} [iEnd] - Index of the last row to delete
         *                         (rows are removed from iStart up to iEnd)
         */
        Delete(iStart, iEnd)
        {
            let eTable = this.eParent;

            if(!iEnd || iEnd < iStart)
            {
                if(iStart >= 0 && iStart < eTable.rows.length)
                {
                    eTable.rows[iStart].remove();    
                }  
            }
            else if(iStart >= 0 && iEnd < eTable.rows.length)
            {
                for(let i = iEnd; i >= iStart; i--)
                {
                    eTable.rows[i].remove(); 
                }
            }
        }

        Insert(iPosition, table_, sSeperator)
        {
            let eTable = this.eParent;

            for(let i = eTable.rows.length; i > iPosition; i--)
            {
                
            } 
        }
    }

    function AddData(eParent, aData)
    {
        if(!eParent) return;

        let eKey = eParent.querySelector("#idName");
        let eValue = eParent.querySelector("#idValue");

        aData.push({key: eKey.value, value: eValue.value});
        eKey.value = "";
        eValue.value = "";
    }

    function UpdateSelect(eParent, sKey, aData)
    {
        if(!eParent) return;

        const aStorageData = JSON.parse(localStorage.getItem(sKey)) || [];
        aData.length = 0;
        aData.push(...aStorageData);

        eParent.innerHTML = "";

        aData.forEach(item_ => {
            const eOption = document.createElement("option");
            eOption.value = item_.key;
            eOption.text = item_.key;
            eParent.appendChild(eOption);
        });
    }

    function GetValue(eParent)
    {
        if(!eParent) return;

        const sValue = eParent.value;
        return sValue;
    }

    function RemoveValue(aData, key_)
    {
        for(let i = 0; i < aData.length; i++)
        {
            if(aData[i].key === key_)
            {
                aData.splice(i, 1);
                return;
            }
        }
    }

    function SetText(eParent, sKey, aData)
    {
        if(!eParent) return;

        let eKey = eParent.querySelector("#idName");
        let eValue = eParent.querySelector("#idValue");

        const foundItem_ = aData.find(item_ => item_.key === sKey); // Error here

        if(foundItem_)
        {
            eKey.value = foundItem_.key;
            eValue.value = foundItem_.value;
        }

    }

    function GlobalEventListener(sAction, eSelector, callback_, eParent)
    {
        if(!eParent) return;

        eParent.addEventListener(sAction, (e_) => {
            if(e_.target.matches(eSelector))
            {
                callback_(e_);
            }
        });
    }

    function InitButtons(eContainer, aData)
    {
        if(!eContainer) return;

        const oButtonActions = {
            "#idAdd": () => {
                AddData(eContainer, aData);
            },

            "#idSave": () => {
                localStorage.setItem("data", JSON.stringify(aData));
                UpdateSelect(eContainer.querySelector("#idSelect"), "data", aData)
            },

            "#idRemove": () => {
                const sValue = GetValue(eContainer.querySelector("#idName"));
                RemoveValue(aData, sValue);
                localStorage.setItem("data", JSON.stringify(aData));
                UpdateSelect(eContainer.querySelector("#idSelect"), "data", aData);
            },

            "#idClear": () => {
                localStorage.clear();
                aData.length = 0;
                UpdateSelect(eContainer.querySelector("#idSelect"), "data", aData);
            }
        }

        Object.keys(oButtonActions).forEach((sSelector) => {
            GlobalEventListener("click", sSelector, oButtonActions[sSelector], eContainer);
        });
    }

    document.addEventListener("DOMContentLoaded", (e_) => {
        const aContainers = document.querySelectorAll(".container");
        //const eTextarea = document.querySelector("#idTextarea");
        //const eLabel = document.querySelector("#idText");
        var aData = [];

        //eLabel.innerHTML = aStoredData;

        //SetText(eTextarea, "text");

        UpdateSelect(document.querySelector("#idSelect"), "data", aData);

        const table = new Table("#idTable");
        const aTableData = [
            ["Cell1", "Cell2", "Cell3", "Cell4"],
            ["Test1", "Test2", "Test3", "Test4"],
            ["Apple1", "Apple2", "Apple3", "Apple4"]
        ];

        const aTableData2 = ["Banana1", "Banana2", "Banana3", "Banana4"];


        table.Add(aTableData);
        table.Add(aTableData2);
        table.Delete(2)


        aContainers.forEach((eContainer) => {
            //GlobalEventListener("click", "button", () => ChangeLabel(eContainer), eContainer);
            /*GlobalEventListener("click", "#idAdd", () => AddData(eContainer.querySelector("#idName"), aData), eContainer);

            GlobalEventListener("click", "#idSave", () => {
                localStorage.setItem("data", JSON.stringify(aData));
                UpdateSelect(eContainer.querySelector("#idSelect"), "data", aData);
            }, eContainer);

            GlobalEventListener("click", "#idRemove", () => {
                const sValue = GetValue(eContainer.querySelector("#idName"));
                RemoveValue(aData, sValue);
                localStorage.setItem("data", JSON.stringify(aData));
                UpdateSelect(eContainer.querySelector("#idSelect"), "data", aData);
            }, eContainer)

            GlobalEventListener("click", "#idClear", () => {localStorage.clear()}, eContainer);*/

            InitButtons(eContainer, aData);

            GlobalEventListener("change", "#idSelect", (e_) => {
                const sValue = GetValue(e_.target);
                SetText(eContainer, sValue, aData);
            }, eContainer);


        });
    });


</script>
</html>
